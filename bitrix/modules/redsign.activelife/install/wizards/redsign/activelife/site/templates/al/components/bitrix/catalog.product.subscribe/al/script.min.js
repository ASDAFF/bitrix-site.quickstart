!function(e){if(!e.JCCatalogProductSubscribe){e.JCCatalogProductSubscribe=function(e){this.buttonId=e.buttonId,this.buttonClass=e.buttonClass,this.jsObject=e.jsObject,this.ajaxUrl="/bitrix/components/bitrix/catalog.product.subscribe/ajax.php",this.alreadySubscribed=e.alreadySubscribed,this.urlListSubscriptions=e.urlListSubscriptions,this.listOldItemId={},this.elemButtonSubscribe=null,this.elemPopupWin=null,this.defaultButtonClass="btn catalog_item__subscr",this._elemButtonSubscribeClickHandler=BX.delegate(this.subscribe,this),this._elemHiddenClickHandler=BX.delegate(this.checkSubscribe,this),BX.ready(BX.delegate(this.init,this))},e.JCCatalogProductSubscribe.prototype.init=function(){this.buttonId&&(this.elemButtonSubscribe=BX(this.buttonId),this.elemHiddenSubscribe=BX(this.buttonId+"_hidden")),this.elemButtonSubscribe&&BX.bind(this.elemButtonSubscribe,"click",this._elemButtonSubscribeClickHandler),this.elemHiddenSubscribe&&BX.bind(this.elemHiddenSubscribe,"click",this._elemHiddenClickHandler),this.setButton(this.alreadySubscribed)},e.JCCatalogProductSubscribe.prototype.checkSubscribe=function(){this.elemHiddenSubscribe&&this.elemButtonSubscribe&&(this.listOldItemId.hasOwnProperty(this.elemButtonSubscribe.dataset.item)?this.setButton(!0):BX.ajax({method:"POST",dataType:"json",url:this.ajaxUrl,data:{sessid:BX.bitrix_sessid(),checkSubscribe:"Y",itemId:this.elemButtonSubscribe.dataset.item},onsuccess:BX.delegate(function(e){e.subscribe?(this.setButton(!0),this.listOldItemId[this.elemButtonSubscribe.dataset.item]=!0):this.setButton(!1)},this)}))},e.JCCatalogProductSubscribe.prototype.subscribe=function(){return this.elemButtonSubscribe=BX.proxy_context,!!this.elemButtonSubscribe&&void BX.ajax({method:"POST",dataType:"json",url:this.ajaxUrl,data:{sessid:BX.bitrix_sessid(),subscribe:"Y",itemId:this.elemButtonSubscribe.dataset.item,siteId:BX.message("SITE_ID")},onsuccess:BX.delegate(function(e){if(e.success)this.createSuccessPopup(e),this.setButton(!0),this.listOldItemId[this.elemButtonSubscribe.dataset.item]=!0;else if(e.contactFormSubmit){var t=this.createContentForPopup(e),s=BX.create("div",{props:{className:"rsform row"},children:[t,BX.create("div",{props:{className:"form-group"},children:[BX.create("button",{text:BX.message("CPST_SUBSCRIBE_BUTTON_SUBSCRIBE"),props:{className:"btn"},events:{click:BX.delegate(function(){return!!this.validateContactField(e.contactTypeData)&&void BX.ajax.submitAjax(t,{method:"POST",url:this.ajaxUrl,processData:!0,onsuccess:BX.delegate(function(e){if(e=BX.parseJSON(e,{}),e.success)this.createSuccessPopup(e),this.setButton(!0),this.listOldItemId[this.elemButtonSubscribe.dataset.item]=!0;else if(e.error){e.hasOwnProperty("setButton")&&(this.listOldItemId[this.elemButtonSubscribe.dataset.item]=!0,this.setButton(!0));var t=e.message;e.hasOwnProperty("typeName")&&(t=e.message.replace("USER_CONTACT",e.typeName)),BX.addClass(BX("bx-catalog-subscribe-form-notify"),"alert alert-danger"),BX("bx-catalog-subscribe-form-notify").innerHTML=t}},this)})},this)}})]})]});$.fancybox(s,$.extend({},appSLine.fancyOptions,{title:BX.message("CPST_SUBSCRIBE_POPUP_TITLE")}))}else e.error&&(e.hasOwnProperty("setButton")&&(this.listOldItemId[this.elemButtonSubscribe.dataset.item]=!0,this.setButton(!0)),this.showWindowWithAnswer({status:"error",message:e.message}))},this)})},e.JCCatalogProductSubscribe.prototype.validateContactField=function(e){var t=BX.findChildren(BX("bx-catalog-subscribe-form"),{tag:"input",attribute:{id:"userContact"}},!0);if(!t.length||"object"!=typeof e)return BX.addClass(BX("bx-catalog-subscribe-form-notify"),"alert alert-danger"),BX("bx-catalog-subscribe-form-notify").innerHTML=BX.message("CPST_SUBSCRIBE_VALIDATE_UNKNOW_ERROR"),!1;for(var s,a,i,c=[],r=[],o=0;o<t.length;o++)s=t[o].getAttribute("data-id"),a=t[o].value,i=BX("bx-contact-use-"+s),i&&"N"==i.value?r.push(!0):a.length||c.push(BX.message("CPST_SUBSCRIBE_VALIDATE_ERROR_EMPTY_FIELD").replace("#FIELD#",e[s].contactLable));if(t.length==r.length)return BX.addClass(BX("bx-catalog-subscribe-form-notify"),"alert alert-danger"),BX("bx-catalog-subscribe-form-notify").innerHTML=BX.message("CPST_SUBSCRIBE_VALIDATE_ERROR"),!1;if(c.length){BX.addClass(BX("bx-catalog-subscribe-form-notify"),"alert alert-danger");for(var n=0;n<c.length;n++)BX("bx-catalog-subscribe-form-notify").innerHTML=c[n];return!1}return!0},e.JCCatalogProductSubscribe.prototype.reloadCaptcha=function(){BX.ajax.get(this.ajaxUrl+"?reloadCaptcha=Y","",function(e){BX("captcha_sid").value=e,BX("captcha_img").src="/bitrix/tools/captcha.php?captcha_sid="+e})},e.JCCatalogProductSubscribe.prototype.createContentForPopup=function(e){if(!e.hasOwnProperty("contactTypeData"))return null;var t=e.contactTypeData,s=Object.keys(t).length,a="",i="N",c=document.createDocumentFragment();s>1&&(i="Y",a="display:none;",c.appendChild(BX.create("p",{text:BX.message("CPST_SUBSCRIBE_MANY_CONTACT_NOTIFY")}))),c.appendChild(BX.create("p",{props:{id:"bx-catalog-subscribe-form-notify"}}));for(var r in t)s>1&&c.appendChild(BX.create("div",{props:{className:"bx-catalog-subscribe-form-container"},children:[BX.create("div",{props:{className:"checkbox"},children:[BX.create("lable",{props:{className:"bx-filter-param-label"},attrs:{onclick:this.jsObject+".selectContactType("+r+", event);"},children:[BX.create("input",{props:{type:"hidden",id:"bx-contact-use-"+r,name:"contact["+r+"][use]",value:"N"}}),BX.create("input",{props:{id:"bx-contact-checkbox-"+r,type:"checkbox"}}),BX.create("span",{props:{className:"bx-filter-param-text"},text:t[r].contactLable})]})]})]})),c.appendChild(BX.create("div",{props:{id:"bx-catalog-subscribe-form-container-"+r,className:"form-group",style:a},children:[BX.create("input",{props:{id:"userContact",className:"form-control",type:"text",name:"contact["+r+"][user]",placeholder:BX.message("CPST_SUBSCRIBE_LABLE_CONTACT_INPUT").replace("#CONTACT#",t[r].contactLable)},attrs:{"data-id":r}})]}));e.hasOwnProperty("captchaCode")&&c.appendChild(BX.create("div",{props:{className:"form-group"},children:[BX.create("input",{props:{type:"hidden",id:"captcha_sid",name:"captcha_sid",value:e.captchaCode}}),BX.create("img",{props:{id:"captcha_img",src:"/bitrix/tools/captcha.php?captcha_sid="+e.captchaCode,className:"captcha-img pull-right"},attrs:{alt:"captcha",onclick:this.jsObject+".reloadCaptcha();"}}),BX.create("div",{props:{className:"l-overflow"},children:[BX.create("input",{props:{id:"captcha_word",className:"form-control",type:"text",name:"captcha_word",placeholder:BX.message("CPST_ENTER_WORD_PICTURE")+"*"},attrs:{maxlength:"50"}})]})]}));var o=BX.create("form",{props:{id:"bx-catalog-subscribe-form"},children:[BX.create("input",{props:{type:"hidden",name:"manyContact",value:i}}),BX.create("input",{props:{type:"hidden",name:"sessid",value:BX.bitrix_sessid()}}),BX.create("input",{props:{type:"hidden",name:"itemId",value:this.elemButtonSubscribe.dataset.item}}),BX.create("input",{props:{type:"hidden",name:"siteId",value:BX.message("SITE_ID")}}),BX.create("input",{props:{type:"hidden",name:"contactFormSubmit",value:"Y"}})]});return o.appendChild(c),o},e.JCCatalogProductSubscribe.prototype.selectContactType=function(t,s){var a=BX("bx-catalog-subscribe-form-container-"+t),i="",c=BX("bx-contact-checkbox-"+t);if(!a)return!1;if(c!=s.target&&(c.checked?c.checked=!1:c.checked=!0),a.currentStyle)i=a.currentStyle.display;else if(e.getComputedStyle){var r=e.getComputedStyle(a,null);i=r.getPropertyValue("display")}"none"===i?(BX("bx-contact-use-"+t).value="Y",BX.style(a,"display","")):(BX("bx-contact-use-"+t).value="N",BX.style(a,"display","none"))},e.JCCatalogProductSubscribe.prototype.createSuccessPopup=function(e){var t=BX.create("div",{props:{className:"rsform row"},children:[BX.create("p",{props:{className:"text-center"},children:[BX.create("img",{props:{src:appSLine.SITE_TEMPLATE_PATH+"/assets/img/like.png"}})]}),BX.create("p",{props:{className:"text-center"},text:e.message}),BX.create("div",{props:{className:"form-group"},children:[BX.create("button",{text:BX.message("CPST_SUBSCRIBE_BUTTON_CLOSE"),props:{className:"btn"},events:{click:BX.delegate(function(){$.fancybox.close()},this)}})]})]});$.fancybox(t,$.extend({},appSLine.fancyOptions,{title:BX.message("CPST_SUBSCRIBE_POPUP_TITLE")}))},e.JCCatalogProductSubscribe.prototype.initPopupWindow=function(){this.elemPopupWin||(this.elemPopupWin=BX.PopupWindowManager.create("CatalogSubscribe_"+this.buttonId,null,{autoHide:!1,offsetLeft:0,offsetTop:0,overlay:!0,closeByEsc:!0,titleBar:!0,closeIcon:!0,contentColor:"white"}))},e.JCCatalogProductSubscribe.prototype.setButton=function(e){this.alreadySubscribed=Boolean(e),this.alreadySubscribed?(this.elemButtonSubscribe.className=this.defaultButtonClass,this.elemButtonSubscribe.innerHTML=BX.message("CPST_TITLE_ALREADY_SUBSCRIBED"),BX.unbind(this.elemButtonSubscribe,"click",this._elemButtonSubscribeClickHandler)):(this.elemButtonSubscribe.className=this.buttonClass+" "+this.defaultButtonClass,this.elemButtonSubscribe.innerHTML=BX.message("CPST_SUBSCRIBE_BUTTON_NAME"),BX.bind(this.elemButtonSubscribe,"click",this._elemButtonSubscribeClickHandler))},e.JCCatalogProductSubscribe.prototype.showWindowWithAnswer=function(e){e=e||{},e.message||("success"==e.status?e.message=BX.message("CPST_STATUS_SUCCESS"):e.message=BX.message("CPST_STATUS_ERROR"));var t=BX.create("div",{props:{className:"bx-catalog-subscribe-alert text-center rsform row"},children:[BX.create("p",{props:{className:"text-center"},children:[BX.create("img",{props:{src:appSLine.SITE_TEMPLATE_PATH+"/assets/img/like.png"}})]}),BX.create("p",{props:{className:"text-center"},children:[BX.create("span",{props:{className:"bx-catalog-subscribe-aligner"}}),BX.create("span",{props:{className:"bx-catalog-subscribe-alert-text"},text:e.message})]}),BX.create("div",{props:{className:"form-group"},children:[BX.create("button",{text:BX.message("CPST_SUBSCRIBE_BUTTON_CLOSE"),props:{className:"btn"},events:{click:BX.delegate(function(){$.fancybox.close()},this)}})]})]}),s=0;$.fancybox(t,$.extend({},appSLine.fancyOptions,{title:BX.message("CPST_SUBSCRIBE_POPUP_TITLE"),afterShow:function(){s=setTimeout(function(){$.fancybox.close()},3500),console.log("afterShow",s),this.wrap.on("mouseenter",function(){clearTimeout(s),console.log("mouseenter",s)}),this.wrap.on("mouseleave",function(){s=setTimeout(function(){$.fancybox.close()},3500),console.log("mouseleave",s)})}}))}}}(window);